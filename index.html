<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcar Ubicación en Mapa</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        #map { height: 400px; width: 100%; }
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        .info { margin-bottom: 20px; }
    </style>
</head>
<body>

    <h2>Marque la ubicación del lugar</h2>
    <p class="info">Haga clic en el mapa o arrastre el marcador para obtener los datos.</p>

    <div id="map"></div>
    <br>
    <p id="direccion"></p>
    <button onclick="enviarCoordenadas()">Continuar al formulario</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var latitudInicial = -25.2637;
        var longitudInicial = -57.5759;

        var coordsGuardadas = null;
        var departamentoGuardado = null;
        var distritoGuardado = null;
        var ciudadGuardada = null;
        var barrioGuardado = null;
        var direccionGuardada = null;

        var map = L.map('map').setView([latitudInicial, longitudInicial], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var marcador = L.marker([latitudInicial, longitudInicial], { draggable: true }).addTo(map);

        function obtenerDireccion(lat, lng) {
            var url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var address = data.address;
                    var textoPantalla = `Lat: ${lat.toFixed(6)}, Lon: ${lng.toFixed(6)}`;
                    
                    var callePrincipal = address.road || '';
                    var calleTransversal = address.crossing || '';
                    var barrio = address.neighbourhood || address.suburb || '';

                    // Si la calle transversal no se encuentra en `crossing`, se busca en el nombre completo de la dirección
                    if (!calleTransversal && data.display_name) {
                        const partes = data.display_name.split(', ');
                        for (let i = 0; i < partes.length; i++) {
                            // Busca la calle principal para luego encontrar la transversal
                            if (partes[i] === callePrincipal) {
                                if (i > 0) {
                                    // La calle transversal es la parte anterior en el nombre completo
                                    calleTransversal = partes[i-1];
                                    break;
                                }
                            }
                        }
                    }

                    let direccionTexto = '';
                    if (callePrincipal && calleTransversal) {
                        direccionTexto = `${callePrincipal} y ${calleTransversal}`;
                    } else if (callePrincipal) {
                        direccionTexto = callePrincipal;
                    } else if (barrio) {
                        direccionTexto = barrio;
                    }

                    if (direccionTexto) {
                        textoPantalla += `<br>Dirección: ${direccionTexto}`;
                        direccionGuardada = direccionTexto;
                    }
                    
                    if (barrio) {
                        textoPantalla += `<br>Barrio: ${barrio}`;
                        barrioGuardado = barrio;
                    }

                    if (address.municipality) {
                        textoPantalla += `<br>Distrito: ${address.municipality}`;
                    }
                    if (address.city) {
                        textoPantalla += `<br>Ciudad: ${address.city}`;
                    } else if (address.town) {
                        textoPantalla += `<br>Ciudad: ${address.town}`;
                    } else if (address.village) {
                        textoPantalla += `<br>Ciudad: ${address.village}`;
                    }
                    if (address.state) {
                        textoPantalla += `<br>Departamento: ${address.state}`;
                    }
                    
                    document.getElementById('direccion').innerHTML = textoPantalla;
                    
                    coordsGuardadas = { lat: lat.toFixed(6), lon: lng.toFixed(6) };
                    departamentoGuardado = address.state || '';
                    distritoGuardado = address.municipality || '';
                    ciudadGuardada = address.city || address.town || address.village || '';
                    if (!barrioGuardado) { 
                      barrioGuardado = address.neighbourhood || address.suburb || '';
                    }
                })
                .catch(error => {
                    console.error('Error al obtener la dirección:', error);
                    document.getElementById('direccion').innerHTML = 'No se pudo obtener la dirección de esa ubicación.';
                });
        }
        
        marcador.on('dragend', function(event) {
            var latLng = event.target.getLatLng();
            obtenerDireccion(latLng.lat, latLng.lng);
        });

        map.on('click', function(event) {
            var latLng = event.latlng;
            marcador.setLatLng(latLng);
            obtenerDireccion(latLng.lat, latLng.lng);
        });
        
        obtenerDireccion(latitudInicial, longitudInicial);

        function enviarCoordenadas() {
            if (coordsGuardadas) {
                var url = "https://docs.google.com/forms/d/e/1FAIpQLSfXlPeQIKBEYyfgJRg-B6vUM2mGbkSqlmVciFJCgTHy9AoSsQ/viewform?usp=pp_url";
                
                url += "&entry.391303732=" + coordsGuardadas.lat;
                url += "&entry.1348054148=" + coordsGuardadas.lon;
                url += "&entry.1192183489=" + encodeURIComponent(departamentoGuardado);
                url += "&entry.1380686983=" + encodeURIComponent(distritoGuardado);
                url += "&entry.643846282=" + encodeURIComponent(ciudadGuardada);
                url += "&entry.236446644=" + encodeURIComponent(barrioGuardado);
                url += "&entry.499772030=" + encodeURIComponent(direccionGuardada);
                
                window.location.href = url;
            } else {
                alert("Por favor, selecciona una ubicación en el mapa antes de continuar.");
            }
        }
    </script>
</body>
</html>
