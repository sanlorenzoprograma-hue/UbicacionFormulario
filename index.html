<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcar Ubicación en Mapa</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        #map { height: 400px; width: 100%; }
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        .info { margin-bottom: 20px; }
    </style>
</head>
<body>

    <h2>Marque la ubicación del lugar</h2>
    <p class="info">Haga clic en el mapa o arrastre el marcador para obtener los datos.</p>

    <div id="map"></div>
    <br>
    <p id="direccion"></p>
    <button onclick="enviarCoordenadas()">Continuar al formulario</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var latitudInicial = -25.2637;
        var longitudInicial = -57.5759;

        var coordsGuardadas = null;
        var departamentoGuardado = null;
        var distritoGuardado = null;
        var ciudadGuardada = null;
        var barrioGuardado = null;
        var direccionGuardada = null;

        var map = L.map('map').setView([latitudInicial, longitudInicial], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var marcador = L.marker([latitudInicial, longitudInicial], { draggable: true }).addTo(map);

        function obtenerDireccion(lat, lng) {
            var url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var address = data.address;
                    var textoPantalla = `Lat: ${lat.toFixed(6)}, Lon: ${lng.toFixed(6)}`;
                    
                    if (address.road) {
                        textoPantalla += `<br>Dirección: ${address.road}`;
                    }
                    if (address.neighbourhood) {
                        textoPantalla += `<br>Barrio: ${address.neighbourhood}`;
                    }
                    if (address.suburb) {
                        textoPantalla += `<br>Barrio: ${address.suburb}`;
                    }
                    if (address.municipality) {
                        textoPantalla += `<br>Distrito: ${address.municipality}`;
                    }
                    if (address.city) {
                        textoPantalla += `<br>Ciudad: ${address.city}`;
                    } else if (address.town) {
                        textoPantalla += `<br>Ciudad: ${address.town}`;
                    } else if (address.village) {
                        textoPantalla += `<br>Ciudad: ${address.village}`;
                    }
                    if (address.state) {
                        textoPantalla += `<br>Departamento: ${address.state}`;
                    }
                    if (address.country) {
                        textoPantalla += `<br>País: ${address.country}`;
                    }

                    document.getElementById('direccion').innerHTML = textoPantalla;
                    
                    // Asignar los valores a las variables globales para el formulario
                    coordsGuardadas = { lat: lat.toFixed(6), lon: lng.toFixed(6) };
                    departamentoGuardado = address.state || '';
                    distritoGuardado = address.municipality || '';
                    ciudadGuardada = address.city || address.town || address.village || '';
                    barrioGuardado = address.neighbourhood || address.suburb || '';
                    direccionGuardada = address.road || '';
                })
                .catch(error => {
                    console.error('Error al obtener la dirección:', error);
                    document.getElementById('direccion').innerHTML = 'No se pudo obtener la dirección de esa ubicación.';
                });
        }
        
        // Actualiza la ubicación cuando se arrastra el marcador
        marcador.on('dragend', function(event) {
            var latLng = event.target.getLatLng();
            obtenerDireccion(latLng.lat, latLng.lng);
        });

        // Actualiza la ubicación cuando se hace clic en el mapa
        map.on('click', function(event) {
            var latLng = event.latlng;
            marcador.setLatLng(latLng);
            obtenerDireccion(latLng.lat, latLng.lng);
        });
    </script>
</body>
</html>
